<table class="table">
	<thead>
		<tr>
			<th>Student</th>
			<th>Action required</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		<% @action_items.each do |a| %>
			<tr>
				<td><%= a.user.name %> (<%= a.user.email %>) </td>
				<td><%= a.reason %></td>
				<td>
					<% case a.reason_code 
					 when "TOO_FEW_REVIEWS" %>
						<%= link_to "Submission", edit_answer_path(a.answer) %> | <%= link_to "Regrade", grades_assignment_path(@assignment, user: a.user_id) %>
					<% when "BLANK_REVIEW" %>
						<%= link_to "Edit review", edit_review_path(a.review) %>
					<% when "BAD_REVIEW" %> 
						<%= link_to "Edit review", rate_review_path(a.review) %>
					<% end %>
				</td>
			</tr>
		<% end %>
	</tbody>
</table>

<table class="table">
	<thead>
		<tr>
			<th>Student name</th>
			<th>Reviews performed: Exchange</th>
			<th>Paired</th>
			<th>Final</th>

			<% @milestones.each do |m| %>
				<th><%= m %> </th>
			<% end %>
			<th>Grade</th>
		</tr>
	</thead>
	<tbody>
		<% grades = (AssignmentGrade.where(assignment: @assignment).group(:user_id).sum(:credit)) 
			grades = Hash[*grades.map {|user, grade| [user,grade.round]}.flatten] 

			%>
		<% @students.order('name').each do |s| %>
			<tr>
				<td><%= s.name %> (<%= s.email %>)</td>
				<% exchange_reviews = Review.where("user_id = ? and review_type='exchange' and active = ? and assignment_id=?", s.id, true, @assignment.id) %>
				<% if exchange_reviews.count == 0 %>
					<td style="background-color: rgb(244,109,67);">
					None</td>
				<% else %>
					<td><%= exchange_reviews.count %></td>
				<% end %>
				<% paired_reviews = Review.where("(user_id = ? or copilot_email= ?) and review_type='paired' and active = ? and assignment_id=?", s.id, s.email, true, @assignment.id) %>
				<% if paired_reviews.count == 0 %>
					<td style="background-color: rgb(244,109,67);">
					None</td>
				<% else %>
					<td><%= paired_reviews.count %></td>
				<% end %>
				<% final_reviews = Review.where("user_id = ? and review_type='final' and active = ? and assignment_id=?", s.id, true, @assignment.id) %>
				<% if final_reviews.count == 0 %>
					<td style="background-color: rgb(244,109,67);">
					None</td>
				<% else %>
					<td><%= final_reviews.count %></td>
				<% end %>

				<% @milestones.each do |m| %>
				<% answer = (answers[m].select {|answer| answer.user_id == s.id}).first
			
				%>
					<% if answer.nil? %>
					<td style="background-color: rgb(244,109,67);">Not Submitted</td>
					<% else %>
						<% if answer.active_reviews.count == 0 %>
							<td style="background-color: rgb(255,255,191);"><%= link_to "Submitted", answer_reviews_path(answer)%>; No reviews</td>
						<% else %>
							<td style="background-color: #8cc665;"><%= link_to "Submitted", answer_reviews_path(answer)%>; <%= answer.active_reviews.count %> reviews</td>
						<% end %>
					<% end %>
				</td>
				<% end %>
				<td><%= grades[s.id] %> <%= link_to "Regrade", grades_assignment_path(@assignment, user: s.id) %></td>
			</tr>
		<% end %>
	</tbody>
</table>

<h2>Export</h2>
<%= link_to "Download gradebook", export_grades_assignment_path(@assignment, format: "csv"), class: "btn" %>




